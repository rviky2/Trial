{% extends 'qpmanager/base.html' %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'qpmanager:home' %}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Search</li>
            </ol>
        </nav>
    </div>
    
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h2 class="text-center mb-0">
                    <i class="fas fa-search me-2"></i>
                    {% if query %}Search Results for "{{ query }}"{% else %}Search{% endif %}
                </h2>
            </div>
            <div class="card-body">
                <form method="get" action="{% url 'qpmanager:search' %}" class="mb-4">
                    <div class="input-group">
                        <input type="text" name="q" class="form-control" placeholder="Search for departments, subjects, question papers..." value="{{ query }}">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search me-1"></i> Search
                        </button>
                    </div>
                </form>
                
                {% if query %}
                    <div class="search-results">
                        <!-- Departments Results -->
                        <div class="mb-5">
                            <h3 class="border-bottom pb-2">
                                <i class="fas fa-university me-2"></i>
                                Departments <span class="badge bg-secondary">{{ results.departments|length }}</span>
                            </h3>
                            
                            {% if results.departments %}
                                <div class="row">
                                    {% for department in results.departments %}
                                        <div class="col-md-6 col-lg-4 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h5 class="card-title">{{ department.name }}</h5>
                                                    {% if department.description %}
                                                        <p class="card-text">{{ department.description|truncatewords:15 }}</p>
                                                    {% endif %}
                                                    <a href="{% url 'qpmanager:department_detail' department.slug %}" class="btn btn-sm btn-primary">
                                                        <i class="fas fa-arrow-right me-1"></i> View Subjects
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No departments found matching "{{ query }}"</p>
                            {% endif %}
                        </div>
                        
                        <!-- Subjects Results -->
                        <div class="mb-5">
                            <h3 class="border-bottom pb-2">
                                <i class="fas fa-book me-2"></i>
                                Subjects <span class="badge bg-secondary">{{ results.subjects|length }}</span>
                            </h3>
                            
                            {% if results.subjects %}
                                <div class="row">
                                    {% for subject in results.subjects %}
                                        <div class="col-md-6 col-lg-4 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <h5 class="card-title">{{ subject.name }}</h5>
                                                    {% if subject.subject_code %}
                                                        <p class="card-text"><strong>Code:</strong> {{ subject.subject_code }}</p>
                                                    {% endif %}
                                                    <p class="card-text"><strong>Department:</strong> {{ subject.department.name }}</p>
                                                    <p class="card-text"><strong>Semester:</strong> 
                                                        {% for sem_val, sem_name in subject.SEMESTER_CHOICES %}
                                                            {% if subject.semester == sem_val %}
                                                                {{ sem_name }}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </p>
                                                    {% if subject.description %}
                                                        <p class="card-text">{{ subject.description|truncatewords:15 }}</p>
                                                    {% endif %}
                                                    <a href="{% url 'qpmanager:subject_detail' subject.department.slug subject.slug %}" class="btn btn-sm btn-primary">
                                                        <i class="fas fa-file-alt me-1"></i> View Question Papers
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted">No subjects found matching "{{ query }}"</p>
                            {% endif %}
                        </div>
                        
                        <!-- Question Papers Results -->
                        <div>
                            <h3 class="border-bottom pb-2">
                                <i class="fas fa-file-alt me-2"></i>
                                Question Papers <span class="badge bg-secondary">{{ results.question_papers|length }}</span>
                            </h3>
                            
                            {% if results.question_papers %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Title</th>
                                                <th>Subject</th>
                                                <th>Subject Code</th>
                                                <th>Year</th>
                                                <th>Month</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for paper in results.question_papers %}
                                                <tr>
                                                    <td>{{ paper.title }}</td>
                                                    <td>
                                                        <a href="{% url 'qpmanager:subject_detail' paper.subject.department.slug paper.subject.slug %}">
                                                            {{ paper.subject.name }}
                                                        </a>
                                                    </td>
                                                    <td>{{ paper.subject_code|default:paper.subject.subject_code }}</td>
                                                    <td>{{ paper.year }}</td>
                                                    <td>
                                                        {% for month_code, month_name in paper.MONTH_CHOICES %}
                                                            {% if paper.month == month_code %}
                                                                {{ month_name }}
                                                            {% endif %}
                                                        {% endfor %}
                                                    </td>
                                                    <td>
                                                        <a href="{% url 'qpmanager:download_paper' paper.id %}" class="btn btn-sm btn-success">
                                                            <i class="fas fa-download me-1"></i> Download
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">No question papers found matching "{{ query }}"</p>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-info mt-4 text-center">
                        <h4 class="alert-heading">Search the SIT eLibrary Portal</h4>
                        <p>Enter a search term above to find departments, subjects, or question papers.</p>
                        <p class="mb-0">You can search by name, code, or description.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %} 